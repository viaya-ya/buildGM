"use strict";(self.webpackChunkgood_management=self.webpackChunkgood_management||[]).push([[414],{8414:(e,s,n)=>{n.r(s),n.d(s,{default:()=>f});var t=n(9379),a=n(5043);const o={dialog:"DesktopDialogPage_dialog__0CwoD",main:"DesktopDialogPage_main__K5jst",body:"DesktopDialogPage_body__yq9vZ"};var r=n(7422),d=n(8877),i=n(3216),c=n(5017),l=n(9497),u=n(3891),g=n(3536),v=n(9542),m=n(579);function f(){const{convertId:e}=(0,i.g)(),[s,n]=(0,a.useState)(0),[f,h]=(0,a.useState)(0),S=(0,a.useRef)(null),[M,I]=(0,a.useState)(),[A,j]=(0,a.useState)([]),x=(0,a.useRef)(null),[E,p]=(0,a.useState)([]),b=[],{currentConvert:C,senderPostId:_,userInfo:T,senderPostName:y,senderPostForSocket:N,sendMessage:k,refetchGetConvertId:F,isLoadingGetConvertId:L,organizationId:P}=(0,d.xz)({convertId:e}),{seenMessages:D,unSeenMessageExist:z,isLoadingSeenMessages:w,isErrorSeenMessages:R,isFetchingSeenMessages:G,unSeenMessages:Q,unSeenMessagesIds:U,isLoadingUnSeenMessages:q,isErrorUnSeenMessages:H,isFetchingUnSeenMessages:O}=(0,d.ot)(e,s),B=(0,a.useRef)(D),K=(0,a.useRef)(z);(0,v.Sf)("join_convert",{convertId:e}),(0,v.Sf)("messagesSeen",{convertId:e,messageIds:E,post:N});const Z=(0,a.useMemo)((()=>["messageCreationEvent","messagesAreSeen"]),[]),J=(0,a.useCallback)(((e,s)=>{console.log("Data from ".concat(e,":"),s)}),[]),V=(0,v.FO)(Z,J),W=(0,g.debounce)((()=>{const e=S.current;if(!e)return;const{scrollTop:s,scrollHeight:t,clientHeight:a}=e;Math.abs(s)>=t-a-200&&!G&&(0,u.z2)(B.current)&&n((e=>e+30))}),200);return(0,a.useLayoutEffect)((()=>{const e=S.current;if(e)return e.addEventListener("scroll",W),()=>{e.removeEventListener("scroll",W)};console.error("Body element is not found!")}),[]),(0,a.useEffect)((()=>{(0,u.z2)(D)?(0,u.z2)(M)?(B.current=D,I((e=>[...e,...D]))):(B.current=D,I(D)):B.current=[]}),[D]),(0,a.useEffect)((()=>{if(!(0,u.z2)(null===V||void 0===V?void 0:V.messageCreationEvent))return;const e=V.messageCreationEvent;j((s=>[...s,{id:e.id,content:e.content,userMessage:e.sender.id===_,attachmentToMessage:e.attachmentToMessage,timeSeen:null,createdAt:e.createdAt}]))}),[null===V||void 0===V?void 0:V.messageCreationEvent]),(0,a.useEffect)((()=>{if(null===V||void 0===V||!V.messagesAreSeen||!Array.isArray(V.messagesAreSeen.messageIds))return;const e=e=>e.map((e=>(console.log(V.messagesAreSeen.messageIds),V.messagesAreSeen.messageIds.includes(e.id)?(console.log("bam"),(0,t.A)((0,t.A)({},e),{},{seenStatuses:["isSeen"]})):e)));if(K.current){const s=e(Q);s.some((e=>V.messagesAreSeen.messageIds.includes(e.id)))?I(s):K.current=!1}const s=e(A);j(s)}),[null===V||void 0===V?void 0:V.messagesAreSeen,z]),(0,a.useLayoutEffect)((()=>{if(!q&&Q.length>0&&x.current){const e=x.current,s=S.current;if(e&&s){const n=e.offsetTop;s.scrollTop=n-170}}}),[Q,q]),(0,a.useEffect)((()=>{const e=new IntersectionObserver((e=>{const s=[];e.forEach((e=>{const n=e.target.dataset.messageId;e.isIntersecting&&!b.includes(n)&&(s.push(n),b.push(n))})),p(s)}),{root:S.current,threshold:.4}),s=S.current.querySelectorAll("[data-message-id]");return s.forEach((s=>e.observe(s))),()=>{s.forEach((s=>e.unobserve(s))),e.disconnect()}}),[Q,A]),console.warn(M,Q),(0,m.jsx)(m.Fragment,{children:(0,m.jsxs)("div",{className:o.dialog,children:[(0,m.jsx)(r.A,{name:null===T||void 0===T?void 0:T.userName,sectionName:T.postName,avatar:null===T||void 0===T?void 0:T.avatar}),(0,m.jsx)("div",{className:o.main,children:(0,m.jsxs)("div",{className:o.body,ref:S,children:[A.slice().reverse().map(((e,s)=>(0,m.jsx)(a.Fragment,{children:(0,m.jsx)(c.Q,(0,t.A)((0,t.A)({userMessage:null===e||void 0===e?void 0:e.userMessage,createdMessage:null===e||void 0===e?void 0:e.createdAt,seenStatuses:null===e||void 0===e?void 0:e.seenStatuses,attachmentToMessage:null===e||void 0===e?void 0:e.attachmentToMessages},!e.userMessage&&{"data-message-id":e.id}),{},{children:e.content}))},s))),Q.length>0&&(0,m.jsxs)(m.Fragment,{children:[null===Q||void 0===Q?void 0:Q.map(((e,s)=>(0,m.jsx)(a.Fragment,{children:(0,m.jsx)(c.Q,{userMessage:null===e||void 0===e?void 0:e.userMessage,createdMessage:null===e||void 0===e?void 0:e.createdAt,ref:s===Q.length-1?x:null,"data-message-id":e.id,attachmentToMessage:null===e||void 0===e?void 0:e.attachmentToMessages,seenStatuses:null===e||void 0===e?void 0:e.seenStatuses,children:e.content})},s))),(0,m.jsx)("div",{className:o.unSeenMessagesInfo,children:" \u041d\u0435\u043f\u0440\u043e\u0447\u0438\u0442\u0430\u043d\u043d\u044b\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f "})]}),null===M||void 0===M?void 0:M.map(((e,s)=>(0,m.jsx)(a.Fragment,{children:(0,m.jsx)(c.Q,{userMessage:null===e||void 0===e?void 0:e.userMessage,seenStatuses:null===e||void 0===e?void 0:e.seenStatuses,senderPost:null===e||void 0===e?void 0:e.sender,attachmentToMessage:null===e||void 0===e?void 0:e.attachmentToMessages,createdMessage:null===e||void 0===e?void 0:e.createdAt,children:e.content},s)},s))),G&&(0,m.jsx)("div",{children:"Loading more messages..."})]})}),(0,m.jsx)("footer",{className:o.footer,children:(0,m.jsx)(l.A,{convertId:null===C||void 0===C?void 0:C.id,sendMessage:k,senderPostId:_,senderPostName:y,refetchMessages:F,isLoadingGetConvertId:L,organizationId:P})})]})})}}}]);
//# sourceMappingURL=414.24b07b23.chunk.js.map