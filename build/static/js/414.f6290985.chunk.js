"use strict";(self.webpackChunkgood_management=self.webpackChunkgood_management||[]).push([[414],{8414:(e,s,n)=>{n.r(s),n.d(s,{default:()=>m});var t=n(5043);const a={dialog:"DesktopDialogPage_dialog__MOt8t",main:"DesktopDialogPage_main__ngLDl",body:"DesktopDialogPage_body__XXTc3"};var o=n(7422),r=n(8877),d=n(3216),i=n(5017),c=n(9497),l=n(3891),u=n(3536),g=n(9542),v=n(579);function m(){const{convertId:e}=(0,d.g)(),[s,n]=(0,t.useState)(0),[m,f]=(0,t.useState)(0),h=(0,t.useRef)(null),[M,S]=(0,t.useState)(),[I,x]=(0,t.useState)([]),E=(0,t.useRef)(null),[j,p]=(0,t.useState)([]),A=[],{currentConvert:b,senderPostId:T,userInfo:_,senderPostName:C,senderPostForSocket:L,sendMessage:N,refetchGetConvertId:k,isLoadingGetConvertId:y,organizationId:F}=(0,r.xz)({convertId:e}),{seenMessages:P,unSeenMessageExist:D,isLoadingSeenMessages:z,isErrorSeenMessages:w,isFetchingSeenMessages:R,unSeenMessages:G,unSeenMessagesIds:O,isLoadingUnSeenMessages:Q,isErrorUnSeenMessages:U,isFetchingUnSeenMessages:H}=(0,r.ot)(e,s),X=(0,t.useRef)(P),q=(0,t.useRef)(D);(0,g.Sf)("join_convert",{convertId:e}),(0,g.Sf)("messagesSeen",{convertId:e,messageIds:j,post:L});const B=(0,t.useMemo)((()=>["messageCreationEvent","messagesAreSeen"]),[]),$=(0,t.useCallback)(((e,s)=>{console.log(`Data from ${e}:`,s)}),[]),J=(0,g.FO)(B,$),K=(0,u.debounce)((()=>{const e=h.current;if(!e)return;const{scrollTop:s,scrollHeight:t,clientHeight:a}=e;Math.abs(s)>=t-a-200&&!R&&(0,l.z2)(X.current)&&n((e=>e+30))}),200);return(0,t.useLayoutEffect)((()=>{const e=h.current;if(e)return e.addEventListener("scroll",K),()=>{e.removeEventListener("scroll",K)};console.error("Body element is not found!")}),[]),(0,t.useEffect)((()=>{(0,l.z2)(P)?(0,l.z2)(M)?(X.current=P,S((e=>[...e,...P]))):(X.current=P,S(P)):X.current=[]}),[P]),(0,t.useEffect)((()=>{if(!(0,l.z2)(null===J||void 0===J?void 0:J.messageCreationEvent))return;const e=J.messageCreationEvent;x((s=>[...s,{id:e.id,content:e.content,userMessage:e.sender.id===T,attachmentToMessage:e.attachmentToMessage,timeSeen:null,createdAt:e.createdAt}]))}),[null===J||void 0===J?void 0:J.messageCreationEvent]),(0,t.useEffect)((()=>{if(null===J||void 0===J||!J.messagesAreSeen||!Array.isArray(J.messagesAreSeen.messageIds))return;const e=e=>e.map((e=>(console.log(J.messagesAreSeen.messageIds),J.messagesAreSeen.messageIds.includes(e.id)?(console.log("bam"),{...e,seenStatuses:["isSeen"]}):e)));if(q.current){const s=e(G);s.some((e=>J.messagesAreSeen.messageIds.includes(e.id)))?S(s):q.current=!1}const s=e(I);x(s)}),[null===J||void 0===J?void 0:J.messagesAreSeen,D]),(0,t.useLayoutEffect)((()=>{if(!Q&&G.length>0&&E.current){const e=E.current,s=h.current;if(e&&s){const n=e.offsetTop;s.scrollTop=n-170}}}),[G,Q]),(0,t.useEffect)((()=>{const e=new IntersectionObserver((e=>{const s=[];e.forEach((e=>{const n=e.target.dataset.messageId;e.isIntersecting&&!A.includes(n)&&(s.push(n),A.push(n))})),p(s)}),{root:h.current,threshold:.4}),s=h.current.querySelectorAll("[data-message-id]");return s.forEach((s=>e.observe(s))),()=>{s.forEach((s=>e.unobserve(s))),e.disconnect()}}),[G,I]),console.warn(M,G),(0,v.jsx)(v.Fragment,{children:(0,v.jsxs)("div",{className:a.dialog,children:[(0,v.jsx)(o.A,{name:null===_||void 0===_?void 0:_.userName,sectionName:_.postName,avatar:null===_||void 0===_?void 0:_.avatar}),(0,v.jsx)("div",{className:a.main,children:(0,v.jsxs)("div",{className:a.body,ref:h,children:[I.slice().reverse().map(((e,s)=>(0,v.jsx)(t.Fragment,{children:(0,v.jsx)(i.Q,{userMessage:null===e||void 0===e?void 0:e.userMessage,createdMessage:null===e||void 0===e?void 0:e.createdAt,seenStatuses:null===e||void 0===e?void 0:e.seenStatuses,attachmentToMessage:null===e||void 0===e?void 0:e.attachmentToMessages,...!e.userMessage&&{"data-message-id":e.id},children:e.content})},s))),G.length>0&&(0,v.jsxs)(v.Fragment,{children:[null===G||void 0===G?void 0:G.map(((e,s)=>(0,v.jsx)(t.Fragment,{children:(0,v.jsx)(i.Q,{userMessage:null===e||void 0===e?void 0:e.userMessage,createdMessage:null===e||void 0===e?void 0:e.createdAt,ref:s===G.length-1?E:null,"data-message-id":e.id,attachmentToMessage:null===e||void 0===e?void 0:e.attachmentToMessages,seenStatuses:null===e||void 0===e?void 0:e.seenStatuses,children:e.content})},s))),(0,v.jsx)("div",{className:a.unSeenMessagesInfo,children:" \u041d\u0435\u043f\u0440\u043e\u0447\u0438\u0442\u0430\u043d\u043d\u044b\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f "})]}),null===M||void 0===M?void 0:M.map(((e,s)=>(0,v.jsx)(t.Fragment,{children:(0,v.jsx)(i.Q,{userMessage:null===e||void 0===e?void 0:e.userMessage,seenStatuses:null===e||void 0===e?void 0:e.seenStatuses,senderPost:null===e||void 0===e?void 0:e.sender,attachmentToMessage:null===e||void 0===e?void 0:e.attachmentToMessages,createdMessage:null===e||void 0===e?void 0:e.createdAt,children:e.content},s)},s))),R&&(0,v.jsx)("div",{children:"Loading more messages..."})]})}),(0,v.jsx)("footer",{className:a.footer,children:(0,v.jsx)(c.A,{convertId:null===b||void 0===b?void 0:b.id,sendMessage:N,senderPostId:T,senderPostName:C,refetchMessages:k,isLoadingGetConvertId:y,organizationId:F})})]})})}}}]);
//# sourceMappingURL=414.f6290985.chunk.js.map